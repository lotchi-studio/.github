name: Release

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
  workflow_call:
    inputs:
      node-version:
        description: "Node.js version to use for changelog generation"
        type: string
        default: "20"
      python-version:
        description: "Python version to use for documentation"
        type: string
        default: "3.13"
      skip-changelog:
        description: "Skip changelog generation"
        type: boolean
        default: false
      skip-docs:
        description: "Skip documentation deployment"
        type: boolean
        default: false
      update-package-py:
        description: "Update version in package.py (Rez packages)"
        type: boolean
        default: false
      package-py-path:
        description: "Path to package.py file"
        type: string
        default: "package.py"
    secrets:
      APP_ID:
        description: "GitHub App ID for changelog commits"
        required: false
      APP_PRIVATE_KEY:
        description: "GitHub App private key for changelog commits"
        required: false
      SLACK_WEBHOOK_URL:
        description: "Slack incoming webhook URL for release notifications"
        required: false
      GH_TOKEN:
        description: "GitHub token for git-committers plugin"
        required: false

permissions:
  contents: write

jobs:
  # Step 0: Update package.py version (for Rez packages)
  update-package-version:
    name: Update package.py Version
    if: ${{ inputs.update-package-py == true }}
    runs-on: ubuntu-latest
    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          token: ${{ steps.app-token.outputs.token || github.token }}

      - name: Update package.py version
        run: |
          TAG_NAME="${GITHUB_REF_NAME:-$(git describe --tags --abbrev=0)}"
          VERSION="${TAG_NAME#v}"
          PACKAGE_PY="${{ inputs.package-py-path || 'package.py' }}"

          if [ -f "$PACKAGE_PY" ]; then
            echo "Updating version in $PACKAGE_PY to $VERSION"
            # Update version = "X.Y.Z" pattern
            sed -i "s/^version\s*=\s*[\"'].*[\"']/version = \"$VERSION\"/" "$PACKAGE_PY"
            echo "Updated $PACKAGE_PY:"
            grep -n "version" "$PACKAGE_PY" || true
          else
            echo "No $PACKAGE_PY found, skipping version update"
          fi

      - name: Commit and push package.py
        run: |
          TAG_NAME="${GITHUB_REF_NAME:-$(git describe --tags --abbrev=0)}"
          VERSION="${TAG_NAME#v}"
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add "${{ inputs.package-py-path || 'package.py' }}"
          if [ -n "$(git status --porcelain)" ]; then
            git commit -m "[BUILD] Bumped Rez package version to ${VERSION}" -m "[skip ci]"
            git push origin main

            # Move the tag to include this commit
            echo "Moving tag $TAG_NAME to include package.py bump..."
            git tag -f "$TAG_NAME"
            git push origin "$TAG_NAME" --force
          else
            echo "No changes to commit"
          fi

  # Step 1: Generate changelog FIRST so it can be included in the release
  generate-changelog:
    name: Generate Changelog
    needs: update-package-version
    if: ${{ always() && !cancelled() && inputs.skip-changelog != true }}
    runs-on: ubuntu-latest
    outputs:
      changelog-section: ${{ steps.extract-changelog.outputs.section }}
    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v1
        env:
          APP_ID: ${{ secrets.APP_ID }}
          APP_PRIVATE_KEY: ${{ secrets.APP_PRIVATE_KEY }}
        if: ${{ env.APP_ID != '' && env.APP_PRIVATE_KEY != '' }}
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          token: ${{ steps.app-token.outputs.token || github.token }}

      - name: Check for package.json
        id: check-npm
        run: |
          if [ -f "package.json" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "No package.json found, skipping changelog generation"
          fi

      - name: Setup Node.js
        if: steps.check-npm.outputs.exists == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version || '20' }}

      - name: Install dependencies
        if: steps.check-npm.outputs.exists == 'true'
        run: npm install && npm install -g auto-changelog

      - name: Generate changelog
        if: steps.check-npm.outputs.exists == 'true'
        run: npm run changelog

      - name: Extract changelog section for this release
        id: extract-changelog
        run: |
          # Extract the section for the current tag from CHANGELOG.md
          TAG_NAME="${GITHUB_REF_NAME:-$(git describe --tags --abbrev=0)}"
          VERSION="${TAG_NAME#v}"

          if [ ! -f "CHANGELOG.md" ]; then
            echo "section=See release notes for details." >> $GITHUB_OUTPUT
            exit 0
          fi

          # Extract content between this version header and the next version header
          SECTION=$(awk "/^## \[?${VERSION}\]?/{found=1; next} /^## \[?[0-9]+\.[0-9]+\.[0-9]+\]?/{if(found) exit} found{print}" CHANGELOG.md)

          # If extraction failed, use a default message
          if [ -z "$SECTION" ]; then
            SECTION="See [CHANGELOG.md](CHANGELOG.md) for details."
          fi

          # Write to output (handle multiline)
          echo "section<<EOF" >> $GITHUB_OUTPUT
          echo "$SECTION" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Remove package-lock.json
        if: steps.check-npm.outputs.exists == 'true'
        run: rm -f package-lock.json

      - name: Commit and push changelog
        if: steps.check-npm.outputs.exists == 'true'
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add CHANGELOG.md
          if [ -n "$(git status --porcelain)" ]; then
            git commit -m '[DOC] CHANGELOG' -m '[skip ci]'
            git push origin main
          else
            echo "No changes to commit"
          fi

  # Step 2: Create release WITH changelog content
  create-release:
    name: Create GitHub Release
    needs: generate-changelog
    if: ${{ always() && !cancelled() }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Create draft release
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          name: ${{ github.ref_name }}
          body: |
            ## What's Changed

            ${{ needs.generate-changelog.outputs.changelog-section || 'See [CHANGELOG.md](CHANGELOG.md) for details.' }}

            ---
            **Full Changelog**: See [CHANGELOG.md](CHANGELOG.md)

  # Step 3: Deploy documentation
  deploy-docs:
    name: Deploy Documentation
    needs: create-release
    if: ${{ always() && !cancelled() && inputs.skip-docs != true }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Check for mkdocs.yml
        id: check-mkdocs
        run: |
          if [ -f "mkdocs.yml" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "No mkdocs.yml found, skipping documentation deployment"
          fi

      - name: Check if using mike
        id: check-mike
        if: steps.check-mkdocs.outputs.exists == 'true'
        run: |
          # Check if mkdocs.yml uses mike as version provider
          if grep -q "provider: mike" mkdocs.yml 2>/dev/null; then
            echo "uses_mike=true" >> $GITHUB_OUTPUT
            echo "Project uses mike for versioned documentation"
          else
            echo "uses_mike=false" >> $GITHUB_OUTPUT
            echo "Project uses standard mkdocs"
          fi

      - name: Setup Python
        if: steps.check-mkdocs.outputs.exists == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python-version || '3.13' }}

      - name: Configure Git for mike
        if: steps.check-mike.outputs.uses_mike == 'true'
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Install dependencies
        if: steps.check-mkdocs.outputs.exists == 'true'
        run: |
          python3 -m pip install --upgrade pip
          if [ -f "requirements.txt" ]; then
            python3 -m pip install -r requirements.txt
          else
            python3 -m pip install mkdocs mkdocs-material
          fi

      - name: Deploy with mike (versioned)
        if: steps.check-mike.outputs.uses_mike == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN || secrets.C14_GITHUB_TOKEN }}
          C14_GITHUB_TOKEN: ${{ secrets.C14_GITHUB_TOKEN }}
        run: |
          TAG_NAME="${GITHUB_REF_NAME:-$(git describe --tags --abbrev=0)}"
          VERSION="${TAG_NAME#v}"
          # Extract major.minor for alias (e.g., 2.1.0 -> 2.1)
          MAJOR_MINOR=$(echo "$VERSION" | cut -d. -f1,2)

          echo "Deploying documentation version: $VERSION (alias: $MAJOR_MINOR, latest)"
          mike deploy --push --update-aliases "$VERSION" latest

      - name: Deploy with mkdocs (standard)
        if: steps.check-mkdocs.outputs.exists == 'true' && steps.check-mike.outputs.uses_mike != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN || secrets.C14_GITHUB_TOKEN }}
        run: mkdocs gh-deploy --force

  # Step 4: Notify Slack
  notify-slack:
    name: Notify Slack
    needs: [create-release, deploy-docs]
    if: ${{ always() && !cancelled() }}
    runs-on: ubuntu-latest
    steps:
      - name: Send Slack notification
        uses: slackapi/slack-github-action@v2.0.0
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        if: ${{ env.SLACK_WEBHOOK_URL != '' }}
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "ðŸš€ New Release: ${{ github.ref_name }}",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Repository:*\n<${{ github.server_url }}/${{ github.repository }}|${{ github.repository }}>"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Version:*\n${{ github.ref_name }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "<${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ github.ref_name }}|ðŸ“¦ View Release> Â· <https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/|ðŸ“š Documentation> Â· <https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/changelog/|ðŸ“ Changelog>"
                  }
                }
              ]
            }
